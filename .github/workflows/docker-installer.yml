name: Docker å®‰è£…ç¨‹åºå·¥ä½œæµ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©16:00 UTC

jobs:
  download_and_verify:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒ
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: è·å–æœ€æ–° Docker LTS ç‰ˆæœ¬
        id: get_latest_version
        run: |
          # ä» Docker çš„é™æ€ç¨³å®šé¡µé¢è·å–æœ€æ–° LTS ç‰ˆæœ¬
          latest_version=$(curl -s https://download.docker.com/linux/static/stable/x86_64/ | grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "æœªæ‰¾åˆ°ç¨³å®šçš„ Docker LTS ç‰ˆæœ¬ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          echo "æœ€æ–°ç¨³å®šçš„ Docker LTS ç‰ˆæœ¬: $latest_version"
          echo "version=$latest_version" >>$GITHUB_ENV

      - name: æ¢å¤å®‰è£…ç¨‹åºç¼“å­˜
        uses: actions/cache@v3
        with:
          path: installers/
          key: docker-installers-${{ env.version }}
          restore-keys: |
            docker-installers-

      - name: ä¸‹è½½ Docker å®‰è£…ç¨‹åº
        run: |
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          declare -A installers=(
            ["windows_x86_64"]="https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe"
            ["mac_arm64"]="https://desktop.docker.com/mac/stable/arm64/Docker.dmg"
            ["mac_x86_64"]="https://desktop.docker.com/mac/stable/amd64/Docker.dmg"
            ["linux_debian_x86_64"]="https://download.docker.com/linux/debian/dists/stable/pool/stable/amd64/docker-ce_${{ env.version }}~3-0~debian-bullseye_amd64.deb"
            ["linux_fedora_x86_64"]="https://download.docker.com/linux/fedora/37/x86_64/stable/Packages/docker-ce-${{ env.version }}.fc37.x86_64.rpm"
            ["linux_ubuntu_x86_64"]="https://download.docker.com/linux/ubuntu/dists/stable/pool/stable/amd64/docker-ce_${{ env.version }}~3-0~ubuntu-jammy_amd64.deb"
            ["linux_centos_x86_64"]="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-${{ env.version }}.ce-1.el7.x86_64.rpm"
          )
          for key in "${!installers[@]}"; do
            url="${installers[$key]}"
            extension="${url##*.}"
            file_name="docker_desktop_installer_${key}.${extension}"
            file_path="$INSTALLER_DIR/$file_name"
            if [ -f "$file_path" ]; then
              echo "$file_name å·²å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
              continue
            fi
            echo "æ­£åœ¨ä» $url ä¸‹è½½$file_name"
            curl -L -o "$file_path" "$url" || { echo "ä¸‹è½½ $file_name å¤±è´¥"; exit 1; }
            if [ ! -s "$file_path" ]; then
              echo "$file_name ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
          done

      - name: ä¿å­˜å®‰è£…ç¨‹åºç¼“å­˜
        uses: actions/cache@v3
        with:
          path: installers/
          key: docker-installers-${{ env.version }}

      - name: ä¸‹è½½ Docker å®‰è£…è„šæœ¬
        run: |
          SCRIPT_URL="https://get.docker.com"
          SCRIPT_FILE="docker_install.sh"
          echo "æ­£åœ¨ä¸‹è½½ Docker å®‰è£…è„šæœ¬ $SCRIPT_URL"
          curl -sL -o "$SCRIPT_FILE" "$SCRIPT_URL" || { echo "ä¸‹è½½ $SCRIPT_FILE å¤±è´¥"; exit 1; }

      - name: è·å– Docker æ›´æ–°æ—¥å¿—
        id: fetch_changelog
        run: |
          # ä» Docker çš„ GitHub å‘å¸ƒé¡µé¢è·å–æ›´æ–°æ—¥å¿—
          changelog_url="https://api.github.com/repos/docker/docker-ce/releases/tags/v${{ env.version }}"
          changelog=$(curl -s "$changelog_url" | jq -r '.body')
          if [ -z "$changelog" ]; then
            echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ ${{ env.version }} çš„æ›´æ–°æ—¥å¿—ã€‚"
            echo "changelog=æ­¤ç‰ˆæœ¬æ— æ›´æ–°æ—¥å¿—ã€‚" >>$GITHUB_ENV
          else
            echo "æ›´æ–°æ—¥å¿—è·å–æˆåŠŸã€‚"
            echo "changelog=$changelog" >>$GITHUB_ENV
          fi

      - name: å‡†å¤‡å‘å¸ƒè¯´æ˜
        run: |
          generate_release_notes() {
            local release_note_file="release_notes.md"

            # æ ‡é¢˜
            echo "# Docker å®‰è£…ç¨‹åº - æœ€æ–° LTS ç¨³å®šç‰ˆæœ¬ ğŸš€" > "$release_note_file"
            echo "" >> "$release_note_file"
            echo "**ç‰ˆæœ¬:** v${{ env.version }}" >> "$release_note_file"
            echo "" >> "$release_note_file"

            # ä»‹ç»
            echo "æ¬¢è¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Docker å®‰è£…ç¨‹åºã€‚ä»¥ä¸‹æ˜¯é€‚ç”¨äºæœ€æ–°ç¨³å®š LTS ç‰ˆæœ¬çš„å®‰è£…ç¨‹åºã€‚è¯·åœ¨å®‰è£…å‰éªŒè¯æ ¡éªŒå’Œä»¥ç¡®ä¿å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚ğŸ’¡" >> "$release_note_file"
            echo "" >> "$release_note_file"

            # è¡¨æ ¼
            echo "| **æ–‡ä»¶åç§°** | **æ–‡ä»¶å¤§å°** | **ä¿®æ”¹æ—¥æœŸ** |" >> "$release_note_file"
            echo "|:-------------:|:-------------:|:-----------------:|" >> "$release_note_file"
            for file in installers/docker_desktop_installer_*.* docker_install.sh; do
              if [ -f "$file" ]; then
                size=$(du -h "$file" | cut -f1)
                modified_date=$(date -r "$file" '+%Y-%m-%d %H:%M:%S')
                echo "| \`$(basename "$file")\` | $size |$modified_date |" >> "$release_note_file"
              fi
            done
            echo "" >> "$release_note_file"

            # æ›´æ–°æ—¥å¿—
            echo "## æ›´æ–°æ—¥å¿— ğŸ“œ" >> "$release_note_file"
            echo "" >> "$release_note_file"
            echo "${{ env.changelog }}" >> "$release_note_file"
            echo "" >> "$release_note_file"

            # ç»“æŸè¯­
            echo "ğŸ”— æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—® [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com)ã€‚" >> "$release_note_file"
            echo "" >> "$release_note_file"
            echo "æ„Ÿè°¢æ‚¨ä½¿ç”¨ Dockerï¼å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦æ”¯æŒï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚ğŸ™Œ" >> "$release_note_file"
            
            # æ˜¾ç¤ºç”Ÿæˆçš„å‘å¸ƒè¯´æ˜
            cat "$release_note_file"
          }
          generate_release_notes

      - name: åˆ é™¤ç°æœ‰å‘å¸ƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        id: delete_release
        uses: actions/github-script@v6
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existingRelease = releases.find(release => release.tag_name === "latest");
            if (existingRelease) {
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.id,
              });
              console.log(`å·²åˆ é™¤æ ‡ç­¾ä¸º "latest" çš„ç°æœ‰å‘å¸ƒã€‚`);
            } else {
              console.log(`æœªæ‰¾åˆ°æ ‡ç­¾ä¸º "latest" çš„ç°æœ‰å‘å¸ƒã€‚`);
            }

      - name: åˆ›å»ºå‘å¸ƒ
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Docker å®‰è£…ç¨‹åº æœ€æ–° LTS ç¨³å®šç‰ˆæœ¬ ${{ env.version }}"
          body_path: release_notes.md
          files: |
            docker_install.sh
            installers/docker_desktop_installer_windows_x86_64.exe
            installers/docker_desktop_installer_mac_arm64.dmg
            installers/docker_desktop_installer_mac_x86_64.dmg
            installers/docker_desktop_installer_linux_debian_x86_64.deb
            installers/docker_desktop_installer_linux_fedora_x86_64.rpm
            installers/docker_desktop_installer_linux_ubuntu_x86_64.deb
            installers/docker_desktop_installer_linux_centos_x86_64.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºå‘å¸ƒè¯´æ˜
        run: |
          cat release_notes.md
        continue-on-error: true
