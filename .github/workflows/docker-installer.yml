name: Docker Installer Workflow

on:
  workflow_dispatch:  # 允许手动触发工作流
  schedule:  # 定时触发工作流，每天16:00 UTC
    - cron: '0 16 * * *'

jobs:
  download_and_verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: Retrieve Latest Docker Version
        id: get_latest_version
        run: |
          latest_version=$(curl -s https://download.docker.com/linux/static/stable/x86_64/ | grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "No stable Docker version found, exiting."
            exit 1
          fi
          echo "Latest stable Docker version: $latest_version"
          echo "version=$latest_version" >>$GITHUB_ENV

      - name: Restore Installers Cache
        uses: actions/cache@v3
        with:
          path: installers/
          key: docker-installers-${{ env.version }}

      - name: Download Docker Installers
        run: |
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          declare -A installers=(
            ["windows_x86_64"]="https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe"
            ["mac_arm64"]="https://desktop.docker.com/mac/stable/arm64/Docker.dmg"
            ["mac_x86_64"]="https://desktop.docker.com/mac/stable/amd64/Docker.dmg"
            ["linux_debian_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_fedora_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm"
            ["linux_ubuntu_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_centos_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.rpm"
          )
          for key in "${!installers[@]}"; do
            url="${installers[$key]}"
            extension="${url##*.}"
            file_name="docker_desktop_installer_${key}.${extension}"
            file_path="$INSTALLER_DIR/$file_name"
            if [ -f "$file_path" ]; then
              echo "$file_name 已存在于缓存中，跳过下载。"
              continue
            fi
            echo "正在从 $url 下载$file_name"
            curl -L -o "$file_path" "$url" || { echo "下载 $file_name 失败"; exit 1; }
            if [ ! -s "$file_path" ]; then
              echo "$file_name 下载失败或文件为空"
              exit 1
            fi
          done

      - name: Save Installers Cache
        uses: actions/cache@v3
        with:
          path: installers/
          key: docker-installers-${{ env.version }}

      - name: Download Docker Installation Script
        run: |
          SCRIPT_URL="https://get.docker.com"
          SCRIPT_FILE="docker_install.sh"
          echo "正在下载 Docker 安装脚本 $SCRIPT_URL"
          curl -sL -o "$SCRIPT_FILE" "$SCRIPT_URL" || { echo "下载 $SCRIPT_FILE 失败"; exit 1; }

      - name: Download Docker Installation Script SHA256
        run: |
          # 假设SHA256值的下载地址
          SHA256_URL="https://download.docker.com/linux/static/stable/x86_64/sha256sums.txt"  # 这个URL需要根据Docker的实际提供方式来修改
          
          echo "正在下载 SHA256 校验值 $SHA256_URL"
          curl -sL -o "expected_sha256.txt" "$SHA256_URL" || { echo "下载SHA256校验值失败"; exit 1; }
          
          EXPECTED_SHA256=$(grep docker_install.sh expected_sha256.txt | awk '{print$1}')
          if [ -z "$EXPECTED_SHA256" ]; then
            echo "无法获取预期的SHA256值"
            exit 1
          fi
          echo "预期的SHA256值是: $EXPECTED_SHA256"
          echo "EXPECTED_SHA256=$EXPECTED_SHA256" >>$GITHUB_ENV

      - name: Verify Docker Installation Script Integrity
        run: |
          if [ ! -s "docker_install.sh" ]; then
            echo "错误：docker_install.sh 文件为空或不存在"
            exit 1
          fi

          ACTUAL_SHA256=$(sha256sum docker_install.sh | awk '{print$1}')
          echo "当前脚本 SHA256: $ACTUAL_SHA256"

          if [ "$ACTUAL_SHA256" != "$EXPECTED_SHA256" ]; then
            echo "错误：SHA256 校验失败，安装脚本可能已被更改。"
            exit 1
          fi

          echo "安装脚本验证成功"

      - name: Prepare Release Notes
        run: |
          generate_release_notes() {
            local release_note_file="release_notes.md"
            echo "# Docker Installer Latest LTS Stable Version" > "$release_note_file"
            echo "" >> "$release_note_file"
            echo "**Version:** v${{ env.version }}" >> "$release_note_file"
            echo "" >> "$release_note_file"
            echo "| File Name | File Size | Modified Date |" >> "$release_note_file"
            echo "| --- | --- | --- |" >> "$release_note_file"
            for file in installers/docker_desktop_installer_*.* docker_install.sh; do
              if [ -f "$file" ]; then
                size=$(du -h "$file" | cut -f1)
                modified_date=$(date -r "$file" '+%Y-%m-%d %H:%M:%S')
                echo "| $(basename "$file") | $size |$modified_date |" >> "$release_note_file"
              fi
            done
            echo "" >> "$release_note_file"
            echo "Thank you for using Docker! If you have any questions, please refer to the official documentation or contact support." >> "$release_note_file"
            cat "$release_note_file"
          }
          generate_release_notes          

      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Docker Installer Latest LTS Stable Version ${{ env.version }}"
          body_path: release_notes.md
          files: |
            docker_install.sh
            installers/docker_desktop_installer_windows_x86_64.exe
            installers/docker_desktop_installer_mac_arm64.dmg
            installers/docker_desktop_installer_mac_x86_64.dmg
            installers/docker_desktop_installer_linux_debian_x86_64.deb
            installers/docker_desktop_installer_linux_fedora_x86_64.rpm
            installers/docker_desktop_installer_linux_ubuntu_x86_64.deb
            installers/docker_desktop_installer_linux_centos_x86_64.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Release Notes
        run: |
          cat release_notes.md
        continue-on-error: true
