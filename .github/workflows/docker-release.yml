# Docker å®‰è£…ç¨‹åºè‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
# åŠŸèƒ½ï¼šè‡ªåŠ¨ä¸‹è½½ã€éªŒè¯å’Œå‘å¸ƒæœ€æ–°ç‰ˆæœ¬çš„Dockerå®‰è£…ç¨‹åº
# ç»´æŠ¤è€…ï¼šæ‚¨çš„å›¢é˜Ÿåç§°
# æœ€åæ›´æ–°ï¼š2024-12-18
# ä¾èµ–ç‰ˆæœ¬ï¼š
#   - Ubuntu: 22.04 LTS (Jammy Jellyfish)
#   - Node.js: 20.x LTS
#   - Python: 3.12.x
#   - actions/checkout: v4.1.1
#   - actions/cache: v3.3.2
#   - anchore/scan-action: v3.1.0
#   - github/codeql-action: v2.22.8
#   - softprops/action-gh-release: v2.0.1
#   - peter-evans/repository-dispatch: v2.1.2
#   - mdformat: 0.7.17
#   - mdformat-gfm: 0.3.5

name: Docker Release Workflow

# ç¯å¢ƒå˜é‡
env:
  INSTALLER_DIR: "installers"
  MINIMUM_FILE_SIZE_MB: 400
  DOWNLOAD_TIMEOUT: 600
  CONNECT_TIMEOUT: 30
  MAX_RETRIES: 3
  CACHE_VERSION: "v1"
  NODE_VERSION: "20.10.0"  # Latest LTS
  PYTHON_VERSION: "3.12.1" # Latest Stable

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©UTC 16:00ï¼ˆçº¦åŒ—äº¬æ—¶é—´00:00ï¼‰è¿è¡Œ

# æƒé™é…ç½®
permissions:
  contents: write
  packages: read
  security-events: write  # ç”¨äºå®‰å…¨æ‰«æç»“æœ

jobs:
  # å®‰å…¨æ£€æŸ¥ä½œä¸š
  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4.1.1
        
      - name: è¿è¡Œ Anchore å®¹å™¨æ‰«æ
        uses: anchore/scan-action@v3.1.0
        id: scan
        with:
          path: "."
          fail-build: false
          severity-cutoff: high
          acs-report-enable: true
        continue-on-error: true
          
      - name: ä¸Šä¼ æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2.22.8
        if: success() || failure()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          wait-for-processing: true
          category: anchore-scan

  # ä¸»è¦å‘å¸ƒä½œä¸š
  release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: security
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4.0.1
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Setup Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        
      - name: å®‰è£…åŸºç¡€å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates gnupg lsb-release
          sudo apt-get install -y --no-install-recommends curl
          
      - name: éªŒè¯å·¥å…·å®‰è£…
        run: |
          which curl
          curl --version

      - name: Setup environment
        run: |
          # æ›´æ–°åˆ°æœ€æ–°çš„è½¯ä»¶åŒ…
          sudo apt-get update -y
          sudo apt-get install -y \
            curl=7.81.0-1ubuntu1.15 \
            jq=1.6-2.1ubuntu3 \
            gpg=2.2.27-3ubuntu2.1 \
            bc=1.07.1-3build1
          
          # åˆ›å»ºå®‰è£…ç›®å½•
          mkdir -p "${{ env.INSTALLER_DIR }}"
          
          # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ä¾èµ–åŒ…
          python -m pip install --upgrade pip
          pip install \
            requests==2.31.0 \
            cryptography==41.0.7 \
            packaging==23.2

      - name: Get latest Docker version
        id: version
        run: |
          echo "æ­£åœ¨è·å–æœ€æ–°Dockerç‰ˆæœ¬..."
          # ä½¿ç”¨ curl çš„æœ€æ–° LTS ç‰¹æ€§
          latest_version=$(curl --http2 --tlsv1.3 -sSL \
            --retry 3 \
            --retry-delay 5 \
            --retry-max-time 30 \
            --connect-timeout 10 \
            https://download.docker.com/linux/static/stable/x86_64/ | 
            grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | 
            sort -V | 
            tail -n 1)
            
          if [[ ! $latest_version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼ - $latest_version"
            exit 1
          fi
          
          echo "âœ… æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š$latest_version"
          echo "version=$latest_version" >> $GITHUB_ENV
          echo "release_tag=v$latest_version" >> $GITHUB_ENV

      - name: Setup download configuration
        id: config
        run: |
          # ä½¿ç”¨ jq 1.6 çš„æ–°ç‰¹æ€§æ ¼å¼åŒ– JSON
          jq -n \
            --arg version "${{ env.version }}" \
            '{
              "installers": {
                "windows_x86_64": {
                  "url": "https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe",
                  "filename": "docker_desktop_installer_windows_x86_64.exe",
                  "min_size": 400,
                  "verify_command": "certutil -hashfile"
                },
                "mac_arm64": {
                  "url": "https://desktop.docker.com/mac/stable/arm64/Docker.dmg",
                  "filename": "docker_desktop_installer_mac_arm64.dmg",
                  "min_size": 400,
                  "verify_command": "shasum -a 256"
                },
                "mac_x86_64": {
                  "url": "https://desktop.docker.com/mac/stable/amd64/Docker.dmg",
                  "filename": "docker_desktop_installer_mac_x86_64.dmg",
                  "min_size": 400,
                  "verify_command": "shasum -a 256"
                },
                "linux_debian_x86_64": {
                  "url": "https://desktop.docker.com/linux/main/amd64/docker-desktop-\($version).deb",
                  "filename": "docker_desktop_installer_linux_debian_x86_64.deb",
                  "min_size": 400,
                  "verify_command": "sha256sum"
                },
                "linux_fedora_x86_64": {
                  "url": "https://desktop.docker.com/linux/main/amd64/docker-desktop-\($version).rpm",
                  "filename": "docker_desktop_installer_linux_fedora_x86_64.rpm",
                  "min_size": 400,
                  "verify_command": "sha256sum"
                },
                "linux_ubuntu_x86_64": {
                  "url": "https://desktop.docker.com/linux/main/amd64/docker-desktop-\($version).deb",
                  "filename": "docker_desktop_installer_linux_ubuntu_x86_64.deb",
                  "min_size": 400,
                  "verify_command": "sha256sum"
                },
                "linux_centos_x86_64": {
                  "url": "https://desktop.docker.com/linux/main/amd64/docker-desktop-\($version).rpm",
                  "filename": "docker_desktop_installer_linux_centos_x86_64.rpm",
                  "min_size": 400,
                  "verify_command": "sha256sum"
                }
              }
            }' > download_config.json

      - name: Restore cache
        uses: actions/cache@v3.3.2
        with:
          path: ${{ env.INSTALLER_DIR }}
          key: ${{ env.CACHE_VERSION }}-docker-installers-${{ env.version }}-${{ hashFiles('download_config.json') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-docker-installers-${{ env.version }}-
            ${{ env.CACHE_VERSION }}-docker-installers-

      - name: Download and verify installers
        run: |
          # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ OpenSSL å’Œ curl åŠŸèƒ½
          export CURL_SSL_BACKEND=openssl
          export SSL_CERT_DIR=/etc/ssl/certs
          
          # ä¸‹è½½å’ŒéªŒè¯å‡½æ•°
          download_and_verify() {
            local url="$1"
            local output_file="$2"
            local min_size_mb="$3"
            local verify_cmd="$4"
            local retry_count=0
            
            while [ $retry_count -lt ${{ env.MAX_RETRIES }} ]; do
              echo "â¬ æ­£åœ¨ä¸‹è½½ $output_file (å°è¯• $((retry_count + 1))/${{ env.MAX_RETRIES }})"
              
              if curl --http2 --tlsv1.3 -L --fail --progress-bar \
                --connect-timeout ${{ env.CONNECT_TIMEOUT }} \
                --max-time ${{ env.DOWNLOAD_TIMEOUT }} \
                --retry 3 --retry-delay 5 \
                --retry-max-time 60 \
                -o "$output_file" "$url"; then
                
                if [ -s "$output_file" ]; then
                  local file_size_mb=$(du -m "$output_file" | cut -f1)
                  
                  if [ "$file_size_mb" -lt "$min_size_mb" ]; then
                    echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶å¤§å°å¼‚å¸¸ ($file_size_mb MB < $min_size_mb MB)"
                    rm -f "$output_file"
                    retry_count=$((retry_count + 1))
                    sleep 5
                    continue
                  fi
                  
                  # è®¡ç®—å¹¶ä¿å­˜æ ¡éªŒå’Œ
                  local file_hash=$($verify_cmd "$output_file" | cut -d' ' -f1)
                  echo "$file_hash" > "${output_file}.sha256"
                  echo "âœ… ä¸‹è½½æˆåŠŸï¼š"
                  echo "   ğŸ“¦ å¤§å°ï¼š${file_size_mb}MB"
                  echo "   ğŸ”’ SHA256ï¼š${file_hash:0:8}..."
                  return 0
                fi
              fi
              
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•..."
              rm -f "$output_file"
              retry_count=$((retry_count + 1))
              sleep 5
            done
            
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$output_file"
            echo "ğŸ” ä¸‹è½½é“¾æ¥ï¼š$url"
            return 1
          }
          
          # è¯»å–é…ç½®å¹¶ä¸‹è½½æ‰€æœ‰å®‰è£…ç¨‹åº
          while IFS= read -r line; do
            eval "local $line"
            local platform=$(echo "$line" | cut -d'=' -f1)
            local url=$(echo "$url" | tr -d '"')
            local filename=$(echo "$filename" | tr -d '"')
            local min_size=$(echo "$min_size" | tr -d '"')
            local verify_cmd=$(echo "$verify_command" | tr -d '"')
            
            file_path="${{ env.INSTALLER_DIR }}/$filename"
            
            # æ£€æŸ¥ç¼“å­˜æ–‡ä»¶
            if [ -f "$file_path" ] && [ -f "${file_path}.sha256" ]; then
              size_mb=$(du -m "$file_path" | cut -f1)
              if [ "$size_mb" -ge "$min_size" ]; then
                echo "ğŸ“¦ ä½¿ç”¨ç¼“å­˜ï¼š$filename ($size_mb MB)"
                continue
              fi
              echo "âš ï¸ ç¼“å­˜æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼Œé‡æ–°ä¸‹è½½ï¼š$filename"
              rm -f "$file_path" "${file_path}.sha256"
            fi
            
            if ! download_and_verify "$url" "$file_path" "$min_size" "$verify_cmd"; then
              exit 1
            fi
          done < <(jq -r '.installers | to_entries | .[] | select(.key) | "url=\(.value.url) filename=\(.value.filename) min_size=\(.value.min_size) verify_command=\(.value.verify_command)"' download_config.json)

      - name: Download installation script
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½Dockerå®‰è£…è„šæœ¬..."
          # ä½¿ç”¨æœ€æ–°çš„ curl ç‰¹æ€§å’Œå®‰å…¨é€‰é¡¹
          curl --http2 --tlsv1.3 -sSL \
            --retry 3 \
            --retry-delay 5 \
            --retry-max-time 30 \
            --connect-timeout 10 \
            -o docker_install.sh \
            https://get.docker.com
          
          # éªŒè¯è„šæœ¬å®Œæ•´æ€§
          if ! grep -q "get.docker.com" docker_install.sh || ! grep -q "Docker CE" docker_install.sh; then
            echo "âŒ å®‰è£…è„šæœ¬éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®é€‚å½“çš„æƒé™
          chmod 755 docker_install.sh
          echo "âœ… å®‰è£…è„šæœ¬ä¸‹è½½å®Œæˆ"

      - name: Generate release notes
        run: |
          # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ markdown å·¥å…·
          pip install --upgrade mdformat==0.7.17 mdformat-gfm==0.3.5
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat << EOF > release_notes.md
          # Docker å®‰è£…ç¨‹åº - æœ€æ–°ç¨³å®šç‰ˆæœ¬
          
          **ç‰ˆæœ¬ï¼š** v${{ env.version }}
          **å‘å¸ƒæ—¥æœŸï¼š** $(date '+%Y-%m-%d')
          **æ”¯æŒå¹³å°ï¼š** Windows, macOS (Intel/ARM), Linux
          
          ## ğŸ“¦ å®‰è£…åŒ…åˆ—è¡¨
          
          | æ–‡ä»¶å | å¤§å° | SHA256æ ¡éªŒå’Œ | å¹³å° |
          |:-------|:-----|:------------|:-----|
          $(for f in ${{ env.INSTALLER_DIR }}/*.*; do
            if [ -f "$f" ]; then
              name=$(basename "$f")
              size=$(numfmt --to=iec-i --suffix=B $(stat -c%s "$f"))
              sha=$(cat "${f}.sha256" 2>/dev/null || echo 'N/A')
              platform=$(echo "$name" | grep -oP '(?<=installer_)[^.]+' || echo 'Unknown')
              echo "| $name | $size | ${sha:0:8}... | $platform |"
            fi
          done)
          
          ## ğŸ“ å®‰è£…è¯´æ˜
          
          ### ç³»ç»Ÿè¦æ±‚
          
          #### Windows
          - Windows 10/11 64ä½ï¼šç‰ˆæœ¬ 21H2 æˆ–æ›´é«˜
          - å¯ç”¨ WSL 2 å’Œè™šæ‹ŸåŒ–åŠŸèƒ½
          - æœ€å°‘ 4GB RAM
          
          #### macOS
          - macOS Monterey 12 æˆ–æ›´é«˜ç‰ˆæœ¬
          - Apple Silicon (M1/M2) æˆ– Intel å¤„ç†å™¨
          - æœ€å°‘ 4GB RAM
          
          #### Linux
          - å†…æ ¸ç‰ˆæœ¬ 5.10 æˆ–æ›´é«˜
          - systemd init ç³»ç»Ÿ
          - KVM è™šæ‹ŸåŒ–æ”¯æŒ
          - æœ€å°‘ 4GB RAM
          
          ### å®‰è£…æ­¥éª¤
          
          #### Windows
          1. ä¸‹è½½ \`docker_desktop_installer_windows_x86_64.exe\`
          2. éªŒè¯æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’Œ
          3. åŒå‡»å®‰è£…ç¨‹åºè¿è¡Œå®‰è£…
          4. æ ¹æ®å‘å¯¼å®Œæˆå®‰è£…
          
          #### macOS
          1. ä¸‹è½½é€‚åˆæ‚¨å¤„ç†å™¨çš„ .dmg æ–‡ä»¶
          2. éªŒè¯æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’Œ
          3. åŒå‡»æ‰“å¼€ .dmg æ–‡ä»¶
          4. å°† Docker.app æ‹–åˆ° Applications æ–‡ä»¶å¤¹
          5. ä»å¯åŠ¨å°è¿è¡Œ Docker Desktop
          
          #### Linux
          
          ##### Ubuntu/Debian
          \`\`\`bash
          # éªŒè¯åŒ…çš„å®Œæ•´æ€§
          sha256sum docker-desktop-*.deb
          # å®‰è£…åŒ…
          sudo apt update
          sudo apt install -y ./docker-desktop-*.deb
          \`\`\`
          
          ##### Fedora/CentOS
          \`\`\`bash
          # éªŒè¯åŒ…çš„å®Œæ•´æ€§
          sha256sum docker-desktop-*.rpm
          # å®‰è£…åŒ…
          sudo dnf install -y ./docker-desktop-*.rpm
          \`\`\`
          
          ### éªŒè¯å®‰è£…
          
          å®‰è£…å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯å®‰è£…ï¼š
          \`\`\`bash
          docker --version
          docker compose version
          docker run hello-world
          \`\`\`
          
          ## ğŸ”„ æ›´æ–°è¯´æ˜
          
          æœ¬ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
          - ä½¿ç”¨æœ€æ–°çš„ Docker Engine ${{ env.version }}
          - å®‰å…¨æ€§å’Œæ€§èƒ½æ”¹è¿›
          - æ”¯æŒæœ€æ–°çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          
          - [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com)
          - [å®‰è£…æŒ‡å—](https://docs.docker.com/desktop/)
          - [å‘è¡Œè¯´æ˜](https://docs.docker.com/desktop/release-notes/)
          - [å¸¸è§é—®é¢˜](https://docs.docker.com/desktop/faqs/)
          
          ## ğŸ’¬ æŠ€æœ¯æ”¯æŒ
          
          å¦‚éœ€å¸®åŠ©ï¼š
          1. è®¿é—® [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com)
          2. åŠ å…¥ [Docker ç¤¾åŒº](https://forums.docker.com)
          3. æäº¤ [GitHub Issue](https://github.com/docker/docker-install/issues)
          
          ## ğŸ”’ å®‰å…¨æç¤º
          
          1. å§‹ç»ˆä»å®˜æ–¹æºä¸‹è½½ Docker
          2. å®‰è£…å‰éªŒè¯æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’Œ
          3. å®šæœŸæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ä»¥è·å–å®‰å…¨è¡¥ä¸
          4. ä½¿ç”¨å®‰å…¨çš„å®¹å™¨é…ç½®
          
          EOF
          
          # æ ¼å¼åŒ– markdown æ–‡ä»¶
          mdformat release_notes.md

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.release_tag }}
          name: "Docker Desktop ${{ env.version }}"
          body_path: release_notes.md
          files: |
            ${{ env.INSTALLER_DIR }}/*.exe
            ${{ env.INSTALLER_DIR }}/*.dmg
            ${{ env.INSTALLER_DIR }}/*.deb
            ${{ env.INSTALLER_DIR }}/*.rpm
            docker_install.sh
            release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f download_config.json
          rm -f *.sha256
          echo "âœ… æ¸…ç†å®Œæˆ"

  # é€šçŸ¥ä½œä¸š
  notify:
    needs: [release]
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
      - name: Send notification
        uses: peter-evans/repository-dispatch@v2.1.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: docker-release-complete
          client-payload: |
            {
              "version": "${{ env.version }}",
              "status": "${{ needs.release.result }}",
              "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
              "environment": "${{ github.event.inputs.environment || 'scheduled' }}"
            }

      - name: æ›´æ–°ç³»ç»ŸåŒ…
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget
          
      - name: æ£€æŸ¥å·¥å…·ç‰ˆæœ¬
        run: |
          curl --version
          wget --version
