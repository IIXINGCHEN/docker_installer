# .github/workflows/docker_installer_workflow.yml
# Final Production-Ready Code 
# (Features: Markdown Table for Assets, Aesthetic Enhancements, Accurate File Count, Zero-Count Handling)

name: Docker Installer Workflow

on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch: {}

jobs:
  download_and_verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          set -euf -o pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl

      - name: Retrieve Latest Docker Version
        id: get_latest_version
        run: |
          set -euf -o pipefail
          latest_version=$(curl -s https://download.docker.com/linux/static/stable/x86_64/ | grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "Error: No stable Docker version found, exiting."
            exit 1
          fi
          echo "Latest stable Docker version: $latest_version"
          echo "version=$latest_version" >>$GITHUB_ENV

      - name: Download Docker Installers
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          
          declare -A installers=(
            ["windows_x86_64"]="https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe"
            ["mac_arm64"]="https://desktop.docker.com/mac/stable/arm64/Docker.dmg"
            ["mac_x86_64"]="https://desktop.docker.com/mac/stable/amd64/Docker.dmg"
            ["linux_debian_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_fedora_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm"
            ["linux_ubuntu_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_centos_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm"
          )
          
          for key in "${!installers[@]}"; do
            url="${installers[$key]}"
            extension="${url##*.}"
            file_name="docker_desktop_installer_${key}.${extension}"
            file_path="$INSTALLER_DIR/$file_name"
            
            echo "æ­£åœ¨ä» $url ä¸‹è½½ $file_name"
            curl -L -o "$file_path" "$url" || { echo "é”™è¯¯ï¼šä¸‹è½½ $file_name å¤±è´¥"; exit 1; }
            
            if [ ! -s "$file_path" ]; then
              echo "é”™è¯¯ï¼š$file_name ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
            echo "$file_name ä¸‹è½½æˆåŠŸ."
          done

      - name: Download Docker Installation Script
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          SCRIPT_URL="https://get.docker.com"
          SCRIPT_FILE_NAME="docker_install.sh"
          SCRIPT_FILE_PATH="$INSTALLER_DIR/$SCRIPT_FILE_NAME"
          echo "æ­£åœ¨ä¸‹è½½ Docker å®‰è£…è„šæœ¬ $SCRIPT_URL åˆ° $SCRIPT_FILE_PATH"
          curl -sL -o "$SCRIPT_FILE_PATH" "$SCRIPT_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $SCRIPT_FILE_NAME å¤±è´¥"; exit 1; }
          echo "$SCRIPT_FILE_NAME ä¸‹è½½æˆåŠŸ."

      - name: Download Docker Engine Static Binary (Linux x86_64)
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          ENGINE_VERSION="${{ env.version }}"
          
          if [ -z "$ENGINE_VERSION" ]; then
            echo "é”™è¯¯ï¼šDockerå¼•æ“ç‰ˆæœ¬ (env.version) æœªè·å–åˆ°ï¼Œæ— æ³•ä¸‹è½½é™æ€äºŒè¿›åˆ¶åŒ…ã€‚"
            exit 1
          fi
          
          STATIC_BINARY_FILE_NAME="docker-${ENGINE_VERSION}.tgz"
          STATIC_BINARY_URL="https://download.docker.com/linux/static/stable/x86_64/${STATIC_BINARY_FILE_NAME}"
          
          mkdir -p "$INSTALLER_DIR"
          echo "æ­£åœ¨ä¸‹è½½ Docker å¼•æ“é™æ€äºŒè¿›åˆ¶åŒ…: $STATIC_BINARY_URL"
          curl -L -o "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" "$STATIC_BINARY_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $STATIC_BINARY_FILE_NAME å¤±è´¥"; exit 1; }
          
          if [ ! -s "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" ]; then
            echo "é”™è¯¯ï¼š$STATIC_BINARY_FILE_NAME ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          echo "$STATIC_BINARY_FILE_NAME ä¸‹è½½æˆåŠŸåˆ° $INSTALLER_DIR/."

      - name: Prepare Release Notes
        run: |
          set -euf -o pipefail
          generate_release_notes() {
            INSTALLER_DIR="installers"
            local release_note_file="release_notes.md"
            local engine_version_from_env="${{ env.version }}" 
            local engine_version_display="v${engine_version_from_env}"

            # Accurately count files by populating an array first
            local files_to_process=()
            while IFS= read -r -d $'\0' f; do files_to_process+=("$f"); done < <(find "$INSTALLER_DIR" -maxdepth 1 -type f -print0)
            local file_count="${#files_to_process[@]}"

            local table_rows_en=""
            local table_rows_zh=""
            
            local current_description="" 
            # local current_description_zh="" # Optional: for separate Chinese descriptions

            if [ "$file_count" -gt 0 ]; then
              # English Table Header and Aligner
              table_rows_en="| ICON | Filename                   | Description                                  | Size    | SHA256                                 | Last Modified (UTC)   |\n"
              table_rows_en+="| :--: | :------------------------- | :------------------------------------------- | :------: | :------------------------------------- | :-------------------- |\n"
              # Chinese Table Header and Aligner
              table_rows_zh="| å›¾æ ‡ | æ–‡ä»¶å                     | æ–‡ä»¶è¯´æ˜                                     | å¤§å°    | SHA256 æ ¡éªŒå’Œ                          | æœ€åä¿®æ”¹æ—¥æœŸ (UTC)   |\n"
              table_rows_zh+="| :--: | :------------------------- | :------------------------------------------- | :------: | :------------------------------------- | :-------------------- |\n"

              for file_path_in_loop in "${files_to_process[@]}"; do
                local filename
                filename=$(basename "$file_path_in_loop")
                local size
                size=$(du -h "$file_path_in_loop" | cut -f1)
                local modified_date
                modified_date=$(stat -c %y "$file_path_in_loop" | cut -d'.' -f1)
                local sha256_hash
                sha256_hash=$(sha256sum "$file_path_in_loop" | cut -d' ' -f1)
                
                local file_icon="ğŸ“¦" # Default ICON

                case "$filename" in
                  "docker_install.sh")
                    current_description="Docker Engine Installation Script (Generic Linux)"
                    # current_description_zh="Docker å¼•æ“å®‰è£…è„šæœ¬ (é€šç”¨ Linux)"
                    file_icon="ğŸ“œ" ;;
                  "docker-${engine_version_from_env}.tgz")
                    current_description="Docker Engine Static Binary ${engine_version_display} (Linux x86_64)"
                    # current_description_zh="Docker å¼•æ“é™æ€äºŒè¿›åˆ¶æ–‡ä»¶ ${engine_version_display} (Linux x86_64)"
                    file_icon="ğŸ§" ;;
                  "docker_desktop_installer_windows_x86_64.exe")
                    current_description="Docker Desktop for Windows (x86_64)"
                    # current_description_zh="Docker Desktop Windows ç‰ˆ (x86_64)"
                    file_icon="ğŸªŸ" ;;
                  "docker_desktop_installer_mac_arm64.dmg")
                    current_description="Docker Desktop for macOS (Apple Silicon, arm64)"
                    # current_description_zh="Docker Desktop macOS ç‰ˆ (Apple Silicon, arm64)"
                    file_icon="ğŸ" ;;
                  "docker_desktop_installer_mac_x86_64.dmg")
                    current_description="Docker Desktop for macOS (Intel, x86_64)"
                    # current_description_zh="Docker Desktop macOS ç‰ˆ (Intel, x86_64)"
                    file_icon="ğŸ" ;;
                  "docker_desktop_installer_linux_debian_x86_64.deb"|\
                  "docker_desktop_installer_linux_ubuntu_x86_64.deb")
                    current_description="Docker Desktop for Linux (Debian/Ubuntu based, .deb)"
                    # current_description_zh="Docker Desktop Linux ç‰ˆ (åŸºäº Debian/Ubuntu, .deb)"
                    file_icon="ğŸ§" ;;
                  "docker_desktop_installer_linux_fedora_x86_64.rpm"|\
                  "docker_desktop_installer_linux_centos_x86_64.rpm")
                    current_description="Docker Desktop for Linux (Fedora/RHEL based, .rpm)"
                    # current_description_zh="Docker Desktop Linux ç‰ˆ (åŸºäº Fedora/RHEL, .rpm)"
                    file_icon="ğŸ§" ;;
                  *)
                    current_description="Utility or Installer File"
                    # current_description_zh="å®ç”¨å·¥å…·æˆ–å®‰è£…æ–‡ä»¶"
                    file_icon="ğŸ“¦" ;;
                esac
                
                table_rows_en+=$(printf "| %s | \`%s\` | %s | %s | \`%s\` | %s |\n" \
                                          "$file_icon" "$filename" "$current_description" "$size" "$sha256_hash" "$modified_date")
                
                local effective_description_zh="$current_description" # Default to English description
                # if [ -n "$current_description_zh" ]; then effective_description_zh="$current_description_zh"; fi

                table_rows_zh+=$(printf "| %s | \`%s\` | %s | %s | \`%s\` | %s |\n" \
                                          "$file_icon" "$filename" "$effective_description_zh" "$size" "$sha256_hash" "$modified_date")
              done
            fi

            {
              echo "## ğŸ³ Docker Installers / Docker å®‰è£…ç¨‹åº - Engine ${engine_version_display} ğŸš€"
              echo "" 
              echo "This document provides download links for various Docker installers and tools, fetched from official sources. The Docker Engine version reference above applies to the static binary and the \`get.docker.com\` script."
              echo "æœ¬æ–‡æ¡£æä¾›äº†å„ Docker å®‰è£…ç¨‹åºå’Œå·¥å…·çš„ä¸‹è½½é“¾æ¥ï¼Œå‡ä»å®˜æ–¹æºè·å–ã€‚ä¸Šè¿° Docker å¼•æ“ç‰ˆæœ¬å·é€‚ç”¨äºé™æ€äºŒè¿›åˆ¶åŒ…åŠ \`get.docker.com\` è„šæœ¬ã€‚"
              echo ""
              echo "---" 
              echo "## ğŸ‡¬ğŸ‡§ English Section"
              echo ""
              echo "### Introduction" 
              echo "This release provides the latest available Docker installers and tools, fetched directly from their official sources. For enhanced security, please verify the SHA256 checksums listed below before installation. ğŸ’¡" 
              echo ""
              echo "### <samp>ğŸ—‚ï¸</samp> Assets (Count: ${file_count})"
              echo "" # Blank line before table or message
              if [ "$file_count" -gt 0 ]; then
                echo -e "${table_rows_en}"
              else
                echo "*No assets available for this release at this time.*"
              fi
              echo "" # Blank line after table or message
              echo "### Notes" 
              echo "ğŸ”— For more information, please visit the [Docker Official Documentation](https://docs.docker.com)."
              echo "ğŸ™Œ Thank you for using Docker!"
              echo ""
              echo "---" 
              echo "## ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯´æ˜"
              echo ""
              echo "### ç®€ä»‹" 
              echo "æ­¤ç‰ˆæœ¬æä¾›äº†ä»å®˜æ–¹æ¥æºè·å–çš„æœ€æ–°å¯ç”¨ Docker å®‰è£…ç¨‹åºå’Œå·¥å…·ã€‚ä¸ºå¢å¼ºå®‰å…¨æ€§ï¼Œè¯·åœ¨å®‰è£…å‰æ ¡éªŒä¸‹æ–¹åˆ—å‡ºçš„ SHA256 æ ¡éªŒå’Œã€‚ğŸ’¡" 
              echo ""
              echo "### <samp>ğŸ—‚ï¸</samp> èµ„äº§æ–‡ä»¶ (æ•°é‡: ${file_count})"
              echo "" # Blank line before table or message
              if [ "$file_count" -gt 0 ]; then
                echo -e "${table_rows_zh}"
              else
                echo "*æœ¬æ¬¡å‘å¸ƒæš‚æ—¶æ²¡æœ‰å¯ç”¨çš„èµ„äº§æ–‡ä»¶ã€‚*"
              fi
              echo "" # Blank line after table or message
              echo "### å¤‡æ³¨" 
              echo "ğŸ”— è·å–æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—® [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com)ã€‚"
              echo "ğŸ™Œ æ„Ÿè°¢æ‚¨ä½¿ç”¨ Dockerï¼"
            } > "$release_note_file"

            echo "--- Generated Release Notes (Content below will be in the GitHub Release) ---" 
            cat "$release_note_file" 
            echo "--- End of Release Notes ---" 
          }
          generate_release_notes

      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Docker Installers - Latest Available (Engine v${{ env.version }})"
          body_path: release_notes.md
          files: |
            installers/docker_install.sh
            installers/docker-${{ env.version }}.tgz
            installers/docker_desktop_installer_windows_x86_64.exe
            installers/docker_desktop_installer_mac_arm64.dmg
            installers/docker_desktop_installer_mac_x86_64.dmg
            installers/docker_desktop_installer_linux_debian_x86_64.deb
            installers/docker_desktop_installer_linux_fedora_x86_64.rpm
            installers/docker_desktop_installer_linux_ubuntu_x86_64.deb
            installers/docker_desktop_installer_linux_centos_x86_64.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Release Notes
        run: |
          set -euf -o pipefail
          echo "Final Release Notes Content (from file):"
          if [ -f "release_notes.md" ]; then
             cat "release_notes.md"
          else
             echo "Warning: release_notes.md not found."
          fi
        continue-on-error: true
