# .github/workflows/docker_installer_workflow.yml
# Final Production-Ready Code 
# (Features: Markdown Table for Assets, Aesthetic Enhancements, Accurate File Count, Zero-Count Handling, Chinese Descriptions, Improved Formatting)

name: Docker Installer Workflow

on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch: {}

jobs:
  download_and_verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          set -euf -o pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl

      - name: Retrieve Latest Docker Version
        id: get_latest_version
        run: |
          set -euf -o pipefail
          latest_version=$(curl -s https://download.docker.com/linux/static/stable/x86_64/ | grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¨³å®šçš„ Docker ç‰ˆæœ¬ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          echo "æœ€æ–°ç¨³å®š Docker ç‰ˆæœ¬: $latest_version"
          echo "version=$latest_version" >>$GITHUB_ENV

      - name: Download Docker Installers
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          
          declare -A installers=(
            ["windows_x86_64"]="https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe"
            ["mac_arm64"]="https://desktop.docker.com/mac/stable/arm64/Docker.dmg"
            ["mac_x86_64"]="https://desktop.docker.com/mac/stable/amd64/Docker.dmg"
            ["linux_debian_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_fedora_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm"
            ["linux_ubuntu_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb"
            ["linux_centos_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm"
          )
          
          for key in "${!installers[@]}"; do
            url="${installers[$key]}"
            extension="${url##*.}"
            file_name="docker_desktop_installer_${key}.${extension}"
            file_path="$INSTALLER_DIR/$file_name"
            
            echo "æ­£åœ¨ä» $url ä¸‹è½½ $file_name"
            curl -L -o "$file_path" "$url" || { echo "é”™è¯¯ï¼šä¸‹è½½ $file_name å¤±è´¥"; exit 1; }
            
            if [ -s "$file_path" ]; then
              echo "$file_name ä¸‹è½½æˆåŠŸ."
            else
              echo "é”™è¯¯ï¼š$file_name ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
          done

      - name: Download Docker Installation Script
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          mkdir -p "$INSTALLER_DIR"
          SCRIPT_URL="https://get.docker.com"
          SCRIPT_FILE_NAME="docker_install.sh"
          SCRIPT_FILE_PATH="$INSTALLER_DIR/$SCRIPT_FILE_NAME"
          echo "æ­£åœ¨ä¸‹è½½ Docker å®‰è£…è„šæœ¬ $SCRIPT_URL åˆ° $SCRIPT_FILE_PATH"
          curl -sL -o "$SCRIPT_FILE_PATH" "$SCRIPT_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $SCRIPT_FILE_NAME å¤±è´¥"; exit 1; }
          echo "$SCRIPT_FILE_NAME ä¸‹è½½æˆåŠŸ."

      - name: Download Docker Engine Static Binary (Linux x86_64)
        run: |
          set -euf -o pipefail
          INSTALLER_DIR="installers"
          ENGINE_VERSION="${{ env.version }}"
          
          if [ -z "$ENGINE_VERSION" ]; then
            echo "é”™è¯¯ï¼šDocker å¼•æ“ç‰ˆæœ¬ (env.version) æœªè·å–åˆ°ï¼Œæ— æ³•ä¸‹è½½é™æ€äºŒè¿›åˆ¶åŒ…ã€‚"
            exit 1
          fi
          
          STATIC_BINARY_FILE_NAME="docker-${ENGINE_VERSION}.tgz"
          STATIC_BINARY_URL="https://download.docker.com/linux/static/stable/x86_64/${STATIC_BINARY_FILE_NAME}"
          
          mkdir -p "$INSTALLER_DIR"
          echo "æ­£åœ¨ä¸‹è½½ Docker å¼•æ“é™æ€äºŒè¿›åˆ¶åŒ…: $STATIC_BINARY_URL"
          curl -L -o "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" "$STATIC_BINARY_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $STATIC_BINARY_FILE_NAME å¤±è´¥"; exit 1; }
          
          if [ -s "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" ]; then
            echo "$STATIC_BINARY_FILE_NAME ä¸‹è½½æˆåŠŸåˆ° $INSTALLER_DIR/."
          else
            echo "é”™è¯¯ï¼š$STATIC_BINARY_FILE_NAME ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi

      - name: Prepare Release Notes
        run: |
          set -euf -o pipefail
          generate_release_notes() {
            INSTALLER_DIR="installers"
            local release_note_file="release_notes.md"
            local assets_table_file="assets_table.md"
            local engine_version_from_env="${{ env.version }}"
            local engine_version_display="v${engine_version_from_env}"
            local current_date=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

            # Accurately count files by populating an array first
            local files_to_process=()
            while IFS= read -r -d $'\0' f; do files_to_process+=("$f"); done < <(find "$INSTALLER_DIR" -maxdepth 1 -type f -print0)
            local file_count="${#files_to_process[@]}"

            local table_rows_en=""
            local table_rows_zh=""
            
            local current_description=""
            local current_description_zh=""

            echo "Debug: Starting generation of assets_table.md with file_count: $file_count"

            if [ "$file_count" -gt 0 ]; then
              # English Table Header and Aligner
              table_rows_en="# **Available Assets** ğŸ—‚ï¸\n\n"
              table_rows_en+="> **Total Assets**: ${file_count} files available for download\n\n"
              table_rows_en+="| **Icon** | **Filename**                       | **Description**                                  | **Size**     | **SHA256**                               | **Last Modified (UTC)** |\n"
              table_rows_en+="| :------: | :--------------------------------- | :----------------------------------------------- | :----------: | :--------------------------------------- | :---------------------- |\n"
              # Chinese Table Header and Aligner
              table_rows_zh="# **å¯ç”¨èµ„äº§æ–‡ä»¶** ğŸ—‚ï¸\n\n"
              table_rows_zh+="> **èµ„äº§æ•°é‡**ï¼š${file_count} ä¸ªæ–‡ä»¶å¯ä¾›ä¸‹è½½\n\n"
              table_rows_zh+="| **å›¾æ ‡** | **æ–‡ä»¶å**                         | **æ–‡ä»¶è¯´æ˜**                                     | **å¤§å°**     | **SHA256 æ ¡éªŒå’Œ**                        | **æœ€åä¿®æ”¹æ—¥æœŸ (UTC)** |\n"
              table_rows_zh+="| :------: | :--------------------------------- | :----------------------------------------------- | :----------: | :--------------------------------------- | :---------------------- |\n"

              for file_path_in_loop in "${files_to_process[@]}"; do
                local filename
                filename=$(basename "$file_path_in_loop")
                local size
                size=$(du -h "$file_path_in_loop" | cut -f1)
                local modified_date
                modified_date=$(stat -c %y "$file_path_in_loop" | cut -d'.' -f1)
                local sha256_hash
                sha256_hash=$(sha256sum "$file_path_in_loop" | cut -d' ' -f1)
                
                local file_icon="ğŸ—„ï¸"

                case "$filename" in
                  "docker_install.sh")
                    current_description="Docker Engine Installation Script (Generic Linux)"
                    current_description_zh="Docker å¼•æ“å®‰è£…è„šæœ¬ï¼ˆé€šç”¨ Linuxï¼‰"
                    file_icon="ğŸ“‹" ;;
                  "docker-${engine_version_from_env}.tgz")
                    current_description="Docker Engine Static Binary ${engine_version_display} (Linux x86_64)"
                    current_description_zh="Docker å¼•æ“é™æ€äºŒè¿›åˆ¶æ–‡ä»¶ ${engine_version_display}ï¼ˆLinux x86_64ï¼‰"
                    file_icon="ğŸ³" ;;
                  "docker_desktop_installer_windows_x86_64.exe")
                    current_description="Docker Desktop for Windows (x86_64)"
                    current_description_zh="Docker Desktop Windows ç‰ˆï¼ˆx86_64ï¼‰"
                    file_icon="ğŸªŸ" ;;
                  "docker_desktop_installer_mac_arm64.dmg")
                    current_description="Docker Desktop for macOS (Apple Silicon, arm64)"
                    current_description_zh="Docker Desktop macOS ç‰ˆï¼ˆApple Siliconï¼Œarm64ï¼‰"
                    file_icon="ğŸ" ;;
                  "docker_desktop_installer_mac_x86_64.dmg")
                    current_description="Docker Desktop for macOS (Intel, x86_64)"
                    current_description_zh="Docker Desktop macOS ç‰ˆï¼ˆIntelï¼Œx86_64ï¼‰"
                    file_icon="ğŸ" ;;
                  "docker_desktop_installer_linux_debian_x86_64.deb"|\
                  "docker_desktop_installer_linux_ubuntu_x86_64.deb")
                    current_description="Docker Desktop for Linux (Debian/Ubuntu based, .deb)"
                    current_description_zh="Docker Desktop Linux ç‰ˆï¼ˆåŸºäº Debian/Ubuntuï¼Œ.deb æ ¼å¼ï¼‰"
                    file_icon="ğŸ³" ;;
                  "docker_desktop_installer_linux_fedora_x86_64.rpm"|\
                  "docker_desktop_installer_linux_centos_x86_64.rpm")
                    current_description="Docker Desktop for Linux (Fedora/RHEL based, .rpm)"
                    current_description_zh="Docker Desktop Linux ç‰ˆï¼ˆåŸºäº Fedora/RHELï¼Œ.rpm æ ¼å¼ï¼‰"
                    file_icon="ğŸ³" ;;
                  *)
                    current_description="Utility or Installer File"
                    current_description_zh="å®ç”¨å·¥å…·æˆ–å®‰è£…æ–‡ä»¶"
                    file_icon="ğŸ—„ï¸" ;;
                esac
                
                table_rows_en+=$(printf "| %s | \`%s\` | %s | %10s | \`%s\` | %s |\n" \
                                          "$file_icon" "$filename" "$current_description" "$size" "$sha256_hash" "$modified_date")
                
                table_rows_zh+=$(printf "| %s | \`%s\` | %s | %10s | \`%s\` | %s |\n" \
                                          "$file_icon" "$filename" "$current_description_zh" "$size" "$sha256_hash" "$modified_date")
              done

              # Write assets table to assets_table.md
              echo "Debug: Writing assets_table.md with content length: ${#table_rows_en}"
              {
                echo "<!-- -*- coding: utf-8 -*- -->"
                echo "${table_rows_en}"
                echo ""
                echo "---"
                echo ""
                echo "${table_rows_zh}"
              } > "$assets_table_file"
              echo "Debug: assets_table.md generation completed, file exists: $( [ -f "$assets_table_file" ] && echo "yes" || echo "no" )"
            fi

            # Write release notes
            {
              echo "<!-- -*- coding: utf-8 -*- -->"
              echo "# ğŸ³ **Docker Installers Release - Engine *${engine_version_display}* ** ğŸš€"
              echo ""
              echo "> **Generated on**: *${current_date}*"
              echo ""
              echo "This release provides the latest Docker installers and tools, fetched from official sources. The Docker Engine version above applies to the static binary and the \`get.docker.com\` script."
              echo "æœ¬æ¬¡å‘å¸ƒæä¾›ä»å®˜æ–¹æ¥æºè·å–çš„æœ€æ–° Docker å®‰è£…ç¨‹åºå’Œå·¥å…·ã€‚ä¸Šè¿° Docker å¼•æ“ç‰ˆæœ¬é€‚ç”¨äºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶åŠ \`get.docker.com\` è„šæœ¬ã€‚"
              echo ""
              echo "---"
              echo "## ğŸ‡¬ğŸ‡§ **Available Assets** ğŸ—‚ï¸"
              echo ""
              echo "> **Overview**"
              echo "> The default 'Assets' section below uses a list style managed by GitHub, which cannot be customized directly. For a detailed and formatted table with SHA256 checksums, please see the linked file."
              echo ""
              if [ "$file_count" -gt 0 ]; then
                echo "**[ğŸ“‹ View Detailed Assets Table](assets_table.md)**"
              else
                echo "*No assets available for this release at this time.*"
              fi
              echo ""
              echo "## ğŸ‡¨ğŸ‡³ **å¯ç”¨èµ„äº§æ–‡ä»¶** ğŸ—‚ï¸"
              echo ""
              echo "> **æ¦‚è¿°**"
              echo "> é»˜è®¤çš„ 'Assets' éƒ¨åˆ†ä½¿ç”¨ GitHub ç®¡ç†çš„åˆ—è¡¨æ ·å¼ï¼Œæ— æ³•ç›´æ¥è‡ªå®šä¹‰ã€‚å¦‚éœ€æŸ¥çœ‹è¯¦ç»†è¡¨æ ¼ï¼ˆåŒ…å« SHA256 æ ¡éªŒå’Œï¼‰ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ã€‚"
              echo ""
              if [ "$file_count" -gt 0 ]; then
                echo "**[ğŸ“‹ æŸ¥çœ‹è¯¦ç»†èµ„äº§è¡¨æ ¼](assets_table.md)**"
              else
                echo "*æœ¬æ¬¡å‘å¸ƒæš‚æ—¶æ²¡æœ‰å¯ç”¨çš„èµ„äº§æ–‡ä»¶ã€‚*"
              fi
              echo ""
              echo "---"
              echo "## **Installation Guide** ğŸ“š"
              echo ""
              echo "### ğŸ‡¬ğŸ‡§ **How to Install**"
              echo "1. **Download**: Select the appropriate installer from the 'Assets' section below or the detailed table."
              echo "2. **Verify**: Use the SHA256 checksum from the table to verify the downloaded file."
              echo "3. **Install**: Follow the official [Docker Installation Instructions](https://docs.docker.com/get-docker/)."
              echo "4. **Get Support**: Visit the [Docker Community](https://www.docker.com/community/) for help."
              echo ""
              echo "**[ğŸ“˜ View Full Documentation](https://docs.docker.com)** | **[ğŸ“© Submit Feedback](https://github.com/docker/docker.github.io/issues)**"
              echo ""
              echo "### ğŸ‡¨ğŸ‡³ **å®‰è£…æŒ‡å—**"
              echo "1. **ä¸‹è½½**ï¼šä»ä¸‹æ–¹ 'Assets' éƒ¨åˆ†æˆ–è¯¦ç»†è¡¨æ ¼ä¸­é€‰æ‹©é€‚åˆæ‚¨å¹³å°çš„å®‰è£…ç¨‹åºã€‚"
              echo "2. **æ ¡éªŒ**ï¼šä½¿ç”¨è¡¨æ ¼ä¸­çš„ SHA256 æ ¡éªŒå’ŒéªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚"
              echo "3. **å®‰è£…**ï¼šæŒ‰ç…§å®˜æ–¹ [Docker å®‰è£…è¯´æ˜](https://docs.docker.com/get-docker/) è¿›è¡Œå®‰è£…ã€‚"
              echo "4. **è·å–æ”¯æŒ**ï¼šè®¿é—® [Docker ç¤¾åŒº](https://www.docker.com/community/) è·å–å¸®åŠ©ã€‚"
              echo ""
              echo "**[ğŸ“˜ æŸ¥çœ‹å®Œæ•´æ–‡æ¡£](https://docs.docker.com)** | **[ğŸ“© æäº¤åé¦ˆ](https://github.com/docker/docker.github.io/issues)**"
              echo ""
              echo "> **Note**: Always download from official sources to ensure security and compatibility. ğŸ™Œ **Thank you for using Docker!**"
            } > "$release_note_file"

            echo "--- Generated Release Notes (Content below will be in the GitHub Release) ---"
            cat "$release_note_file"
            echo "--- End of Release Notes ---"
          }
          generate_release_notes

      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Docker Installers - Latest Available (Engine v${{ env.version }})"
          body_path: release_notes.md
          files: |
            installers/docker_install.sh
            installers/docker-${{ env.version }}.tgz
            installers/docker_desktop_installer_windows_x86_64.exe
            installers/docker_desktop_installer_mac_arm64.dmg
            installers/docker_desktop_installer_mac_x86_64.dmg
            installers/docker_desktop_installer_linux_debian_x86_64.deb
            installers/docker_desktop_installer_linux_fedora_x86_64.rpm
            installers/docker_desktop_installer_linux_ubuntu_x86_64.deb
            installers/docker_desktop_installer_linux_centos_x86_64.rpm
            assets_table.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Release Notes
        run: |
          set -euf -o pipefail
          echo "Final Release Notes Content (from file):"
          if [ -f "release_notes.md" ]; then
             cat "release_notes.md"
          else
             echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° release_notes.mdã€‚"
          fi
          echo "Debug: Checking assets_table.md existence: $( [ -f "assets_table.md" ] && echo "yes" || echo "no" )"
        continue-on-error: true
