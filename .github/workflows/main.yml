# .github/workflows/docker_installer_workflow.yml # å·¥ä½œæµæ–‡ä»¶çš„å»ºè®®å­˜æ”¾è·¯å¾„å’Œåç§°
name: Docker Installer Workflow # å·¥ä½œæµçš„åç§°ï¼Œå°†æ˜¾ç¤ºåœ¨GitHub Actionsçš„UIç•Œé¢ä¸­

on: # å®šä¹‰è§¦å‘æ­¤å·¥ä½œæµçš„äº‹ä»¶
  schedule: # å®šæ—¶è§¦å‘å™¨é…ç½®
    - cron: '0 16 * * *'  # CRONè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºæ¯å¤©UTCæ—¶é—´16:00æ‰§è¡Œ (é€šå¸¸å¯¹åº”ä¸­å›½æ ‡å‡†æ—¶é—´CSTçš„æ¬¡æ—¥å‡Œæ™¨0ç‚¹)
  workflow_dispatch: {} # å…è®¸é€šè¿‡GitHub Actions UIç•Œé¢æˆ–APIæ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

jobs: # å®šä¹‰å·¥ä½œæµä¸­åŒ…å«çš„ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸š
  download_and_verify: # ä½œä¸šçš„å”¯ä¸€IDï¼Œæ­¤ä½œä¸šè´Ÿè´£ä¸‹è½½å’ŒéªŒè¯å®‰è£…ç¨‹åº
    runs-on: ubuntu-latest # æŒ‡å®šä½œä¸šè¿è¡Œåœ¨GitHubæ‰˜ç®¡çš„æœ€æ–°ç‰ˆUbuntu Linuxè™šæ‹Ÿç¯å¢ƒ

    steps: # ä½œä¸šä¸­æ‰§è¡Œçš„ä¸€ç³»åˆ—æ­¥éª¤ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ
      - name: Checkout repository # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4 # ä½¿ç”¨GitHubå®˜æ–¹æä¾›çš„actions/checkout@v4åŠ¨ä½œæ¥æ£€å‡ºå½“å‰ä»“åº“çš„ä»£ç åˆ°è¿è¡Œå™¨ç¯å¢ƒ

      - name: Set up environment # æ­¥éª¤2ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼: -e(é”™è¯¯æ—¶é€€å‡º), -u(æœªå®šä¹‰å˜é‡è§†ä¸ºé”™è¯¯), -f(ç¦ç”¨é€šé…ç¬¦), -o pipefail(ç®¡é“å¤±è´¥åˆ™æ•´ä¸ªç®¡é“å¤±è´¥)
          sudo apt-get update -y # ä½¿ç”¨sudoæƒé™æ›´æ–°aptåŒ…ç®¡ç†å™¨çš„è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œ-yé€‰é¡¹è¡¨ç¤ºè‡ªåŠ¨ç¡®è®¤æ‰€æœ‰æç¤º
          sudo apt-get install -y curl # ä½¿ç”¨sudoæƒé™å®‰è£…curlå·¥å…·ï¼Œç”¨äºè¿›è¡ŒHTTPè¯·æ±‚ä»¥ä¸‹è½½æ–‡ä»¶ï¼Œ-yé€‰é¡¹è‡ªåŠ¨ç¡®è®¤

      - name: Retrieve Latest Docker Version # æ­¥éª¤3ï¼šè·å–æœ€æ–°çš„Dockerå¼•æ“ç¨³å®šç‰ˆæœ¬å·
        id: get_latest_version # ä¸ºæ­¤æ­¥éª¤è®¾ç½®ä¸€ä¸ªID "get_latest_version"ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤å¼•ç”¨å…¶è¾“å‡º
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼
          # é€šè¿‡curlé™é»˜(-s)è®¿é—®Dockerå®˜æ–¹ä¸‹è½½é¡µé¢ï¼Œè·å–Linux x86_64æ¶æ„çš„ç¨³å®šç‰ˆ(stable)é™æ€æ–‡ä»¶åˆ—è¡¨
          # ä½¿ç”¨grepé€šè¿‡Perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼(-P)å’Œä»…è¾“å‡ºåŒ¹é…éƒ¨åˆ†(-o)çš„é€‰é¡¹ï¼Œæå–æ‰€æœ‰å½¢å¦‚ 'docker-X.Y.Z' ä¸­çš„ç‰ˆæœ¬å· 'X.Y.Z'
          # (\Kä¼šå¿½ç•¥ä¹‹å‰åŒ¹é…åˆ°çš„ "docker-")
          # ä½¿ç”¨sort -VæŒ‰ç‰ˆæœ¬å·è¿›è¡Œè‡ªç„¶æ’åºï¼ˆä¾‹å¦‚ï¼Œ2.10.0ä¼šæ’åœ¨2.9.0ä¹‹åï¼‰
          # ä½¿ç”¨tail -n 1å–æ’åºåçš„æœ€åä¸€è¡Œï¼Œå³æœ€æ–°çš„ç‰ˆæœ¬å·
          latest_version=$(curl -s https://download.docker.com/linux/static/stable/x86_64/ | grep -oP 'docker-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then # æ£€æŸ¥è·å–åˆ°çš„latest_versionå˜é‡æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²
            echo "Error: No stable Docker version found, exiting." # å¦‚æœä¸ºç©ºï¼Œåˆ™æ‰“å°é”™è¯¯ä¿¡æ¯
            exit 1 # è„šæœ¬ä»¥å¤±è´¥çŠ¶æ€é€€å‡ºï¼Œè¿™å°†å¯¼è‡´æ­¤æ­¥éª¤å¤±è´¥
          fi
          echo "Latest stable Docker version: $latest_version" # æ‰“å°è·å–åˆ°çš„æœ€æ–°Dockerå¼•æ“ç¨³å®šç‰ˆæœ¬å·
          # å°†è·å–åˆ°çš„ç‰ˆæœ¬å·ä»¥ "version=<ç‰ˆæœ¬å·>" çš„æ ¼å¼è¿½åŠ åˆ°$GITHUB_ENVç¯å¢ƒå˜é‡æ–‡ä»¶ä¸­
          # è¿™æ ·åç»­æ­¥éª¤å¯ä»¥é€šè¿‡ ${{ env.version }} æ¥å¼•ç”¨è¿™ä¸ªç‰ˆæœ¬å·
          echo "version=$latest_version" >>$GITHUB_ENV

      - name: Download Docker Installers # æ­¥éª¤4ï¼šä¸‹è½½Docker Desktopå®‰è£…ç¨‹åº
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼
          INSTALLER_DIR="installers" # å®šä¹‰å®‰è£…ç¨‹åºå­˜æ”¾çš„ç›®å½•å
          mkdir -p "$INSTALLER_DIR" # åˆ›å»ºè¯¥ç›®å½•ï¼Œ-pé€‰é¡¹è¡¨ç¤ºå¦‚æœçˆ¶ç›®å½•ä¸å­˜åœ¨ä¹Ÿä¼šä¸€å¹¶åˆ›å»ºï¼Œä¸”ç›®å½•å·²å­˜åœ¨æ—¶ä¸æŠ¥é”™
          
          # å£°æ˜ä¸€ä¸ªbashå…³è”æ•°ç»„(associative array)åä¸ºinstallersï¼Œç”¨äºå­˜å‚¨å„ç§å¹³å°çš„Docker Desktopä¸‹è½½é“¾æ¥
          declare -A installers=(
            ["windows_x86_64"]="https://desktop.docker.com/win/stable/amd64/Docker%20Desktop%20Installer.exe" # Windows x86_64å¹³å°
            ["mac_arm64"]="https://desktop.docker.com/mac/stable/arm64/Docker.dmg" # Mac arm64 (Apple Silicon)å¹³å°
            ["mac_x86_64"]="https://desktop.docker.com/mac/stable/amd64/Docker.dmg" # Mac x86_64 (Intel)å¹³å°
            ["linux_debian_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb" # Linux Debian/Ubuntu x86_64å¹³å° (.deb)
            ["linux_fedora_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm" # Linux Fedora/CentOS x86_64å¹³å° (.rpm)
            ["linux_ubuntu_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-amd64.deb" # Linux Ubuntu (ä¸Debianä½¿ç”¨ç›¸åŒçš„æœ€æ–°é“¾æ¥)
            ["linux_centos_x86_64"]="https://desktop.docker.com/linux/main/amd64/docker-desktop-latest-x86_64.rpm" # Linux CentOS (ä¸Fedoraä½¿ç”¨ç›¸åŒçš„æœ€æ–°é“¾æ¥)
          )
          
          # éå†installerså…³è”æ•°ç»„çš„æ‰€ç”¨é”®(key)
          for key in "${!installers[@]}"; do
            url="${installers[$key]}" # è·å–å½“å‰é”®å¯¹åº”çš„ä¸‹è½½URL
            extension="${url##*.}" # ä»URLä¸­æå–æ–‡ä»¶æ‰©å±•å (ä¾‹å¦‚ .exe, .dmg, .deb, .rpm)
            file_name="docker_desktop_installer_${key}.${extension}" # æ„å»ºæœ¬åœ°ä¿å­˜çš„æ–‡ä»¶å
            file_path="$INSTALLER_DIR/$file_name" # æ„å»ºæœ¬åœ°ä¿å­˜çš„å®Œæ•´æ–‡ä»¶è·¯å¾„
            
            echo "æ­£åœ¨ä» $url ä¸‹è½½ $file_name" # æ‰“å°ä¸‹è½½ä¿¡æ¯
            curl -L -o "$file_path" "$url" || { echo "é”™è¯¯ï¼šä¸‹è½½ $file_name å¤±è´¥"; exit 1; }
            
            if [ ! -s "$file_path" ]; then # æ£€æŸ¥ä¸‹è½½åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¤§å°æ˜¯å¦å¤§äº0 (-s)
              echo "é”™è¯¯ï¼š$file_name ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
            echo "$file_name ä¸‹è½½æˆåŠŸ."
          done

      - name: Download Docker Installation Script # æ­¥éª¤5ï¼šä¸‹è½½Dockerå¼•æ“çš„ä¾¿æ·å®‰è£…è„šæœ¬
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼
          INSTALLER_DIR="installers" # å®šä¹‰å®‰è£…ç¨‹åºå­˜æ”¾çš„ç›®å½•å
          mkdir -p "$INSTALLER_DIR" # ç¡®ä¿ç›®å½•å­˜åœ¨
          SCRIPT_URL="https://get.docker.com" # Dockerå¼•æ“å®‰è£…è„šæœ¬çš„URL
          SCRIPT_FILE_NAME="docker_install.sh" # Dockerå¼•æ“å®‰è£…è„šæœ¬çš„æ–‡ä»¶å
          SCRIPT_FILE_PATH="$INSTALLER_DIR/$SCRIPT_FILE_NAME" # æœ¬åœ°ä¿å­˜çš„å®Œæ•´æ–‡ä»¶è·¯å¾„
          echo "æ­£åœ¨ä¸‹è½½ Docker å®‰è£…è„šæœ¬ $SCRIPT_URL åˆ° $SCRIPT_FILE_PATH" # æ‰“å°ä¸‹è½½ä¿¡æ¯
          curl -sL -o "$SCRIPT_FILE_PATH" "$SCRIPT_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $SCRIPT_FILE_NAME å¤±è´¥"; exit 1; }
          echo "$SCRIPT_FILE_NAME ä¸‹è½½æˆåŠŸ."

      - name: Download Docker Engine Static Binary (Linux x86_64) # æ­¥éª¤6ï¼šä¸‹è½½Dockerå¼•æ“é™æ€äºŒè¿›åˆ¶åŒ…
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼
          INSTALLER_DIR="installers" # å®šä¹‰å®‰è£…ç¨‹åºå­˜æ”¾çš„ç›®å½•å
          ENGINE_VERSION="${{ env.version }}" # ä» 'Retrieve Latest Docker Version' æ­¥éª¤è·å–çš„Dockerå¼•æ“ç‰ˆæœ¬
          
          if [ -z "$ENGINE_VERSION" ]; then # æ£€æŸ¥ENGINE_VERSIONæ˜¯å¦ä¸ºç©º
            echo "é”™è¯¯ï¼šDockerå¼•æ“ç‰ˆæœ¬ (env.version) æœªè·å–åˆ°ï¼Œæ— æ³•ä¸‹è½½é™æ€äºŒè¿›åˆ¶åŒ…ã€‚"
            exit 1
          fi
          
          STATIC_BINARY_FILE_NAME="docker-${ENGINE_VERSION}.tgz" # æ„é€ é™æ€äºŒè¿›åˆ¶åŒ…çš„æ–‡ä»¶å
          STATIC_BINARY_URL="https://download.docker.com/linux/static/stable/x86_64/${STATIC_BINARY_FILE_NAME}" # æ„é€ ä¸‹è½½URL
          
          mkdir -p "$INSTALLER_DIR" # å†æ¬¡ç¡®ä¿ç›®å½•å­˜åœ¨
          echo "æ­£åœ¨ä¸‹è½½ Docker å¼•æ“é™æ€äºŒè¿›åˆ¶åŒ…: $STATIC_BINARY_URL" # æ‰“å°ä¸‹è½½ä¿¡æ¯
          curl -L -o "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" "$STATIC_BINARY_URL" || { echo "é”™è¯¯ï¼šä¸‹è½½ $STATIC_BINARY_FILE_NAME å¤±è´¥"; exit 1; }
          
          if [ ! -s "$INSTALLER_DIR/$STATIC_BINARY_FILE_NAME" ]; then # æ£€æŸ¥ä¸‹è½½åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¤§å°æ˜¯å¦å¤§äº0
            echo "é”™è¯¯ï¼š$STATIC_BINARY_FILE_NAME ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          echo "$STATIC_BINARY_FILE_NAME ä¸‹è½½æˆåŠŸåˆ° $INSTALLER_DIR/."

      - name: Prepare Release Notes # æ­¥éª¤7ï¼šå‡†å¤‡Releaseçš„è¯´æ˜æ–‡æ¡£ (Release Notes)
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼
          generate_release_notes() { # å®šä¹‰ä¸€ä¸ªåä¸ºgenerate_release_notesçš„bashå‡½æ•°
            INSTALLER_DIR="installers" # æ˜ç¡®å®šä¹‰ä¸‹è½½äº§ç‰©ç›®å½•ï¼Œç¡®ä¿å‡½æ•°å†…å¯ç”¨
            local release_note_file="release_notes.md" # å®šä¹‰Release Notesæ–‡ä»¶å (æœ¬åœ°å˜é‡)

            # ç”ŸæˆMarkdownæ–‡ä»¶çš„å¤´éƒ¨ä¿¡æ¯
            echo "# Docker Installer - Latest Available Versions ğŸš€" > "$release_note_file" # ä¸»æ ‡é¢˜ (è¦†ç›–å†™å…¥)
            echo "" >> "$release_note_file" # è¿½åŠ ä¸€ä¸ªç©ºè¡Œ
            echo "**Docker Engine Version (for static binary & get.docker.com script reference):** v${{ env.version }}" >> "$release_note_file" # ç‰ˆæœ¬ä¿¡æ¯
            echo "" >> "$release_note_file" # è¿½åŠ ä¸€ä¸ªç©ºè¡Œ

            # ç”Ÿæˆå¼•è¨€éƒ¨åˆ†
            echo "This release contains the latest available Docker installers and tools fetched from their official sources. Ensure to verify checksums for integrity and security before installation. ğŸ’¡" >> "$release_note_file"
            echo "" >> "$release_note_file"

            # ç”ŸæˆåŒ…å«æ–‡ä»¶ä¿¡æ¯çš„Markdownè¡¨æ ¼å¤´éƒ¨
            echo "| **File Name** | **File Size** | **Last Modified (UTC)** |" >> "$release_note_file" # è¡¨æ ¼æ ‡é¢˜è¡Œ
            echo "|:-------------:|:-------------:|:-----------------------:|" >> "$release_note_file" # è¡¨æ ¼å¯¹é½æ–¹å¼æ§åˆ¶è¡Œ
            
            # éå†installersç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
            for file in "$INSTALLER_DIR"/*; do 
              if [ -f "$file" ]; then # æ£€æŸ¥æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶
                size=$(du -h "$file" | cut -f1) # è·å–äººç±»å¯è¯»çš„æ–‡ä»¶å¤§å°
                modified_date=$(stat -c %y "$file" | cut -d'.' -f1) # è·å–æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¥æœŸ(UTC YYYY-MM-DD HH:MM:SS)
                echo "| \`$(basename "$file")\` | $size | $modified_date |" >> "$release_note_file" 
              fi
            done
            echo "" >> "$release_note_file" # è¿½åŠ ä¸€ä¸ªç©ºè¡Œ

            # ç”Ÿæˆç»“æŸè¯­å’Œé“¾æ¥
            echo "ğŸ”— For more information, please visit [Docker Official Documentation](https://docs.docker.com)." >> "$release_note_file"
            echo "" >> "$release_note_file"
            echo "Thank you for using Docker! Should you have any questions or need support, feel free to reach out to us. ğŸ™Œ" >> "$release_note_file"
            
            echo "--- Generated Release Notes ---" # æ§åˆ¶å°è¾“å‡ºæ ‡è®°
            cat "$release_note_file" # åœ¨Runnerçš„æ§åˆ¶å°æ‰“å°ç”Ÿæˆçš„Release Noteså†…å®¹
            echo "--- End of Release Notes ---" # æ§åˆ¶å°è¾“å‡ºæ ‡è®°
          }
          generate_release_notes # è°ƒç”¨å®šä¹‰çš„bashå‡½æ•°æ¥å®é™…ç”ŸæˆRelease Notes

      - name: Create Release # æ­¥éª¤8ï¼šåˆ›å»ºGitHub Release
        id: release # ä¸ºæ­¤æ­¥éª¤è®¾ç½®ID "release"
        uses: softprops/action-gh-release@v2 # ä½¿ç”¨softprops/action-gh-release@v2åŠ¨ä½œæ¥åˆ›å»ºRelease
        with: # é…ç½®å‚æ•°
          tag_name: "latest" # Releaseçš„æ ‡ç­¾åï¼Œè®¾ç½®ä¸ºé™æ€çš„ "latest" (ä¼šè¦†ç›–åŒåæ—§æ ‡ç­¾)
          name: "Docker Installers - Latest Available (Engine v${{ env.version }})" # Releaseçš„åç§°
          body_path: release_notes.md # Releaseçš„è¯´æ˜å†…å®¹ä» "release_notes.md" æ–‡ä»¶è¯»å–
          # åˆ—å‡ºè¦é™„åŠ åˆ°Releaseçš„èµ„äº§æ–‡ä»¶ (assets)
          files: | # å¤šè¡Œå­—ç¬¦ä¸²ï¼Œæ¯è¡Œä¸€ä¸ªæ–‡ä»¶è·¯å¾„
            installers/docker_install.sh
            installers/docker-${{ env.version }}.tgz
            installers/docker_desktop_installer_windows_x86_64.exe
            installers/docker_desktop_installer_mac_arm64.dmg
            installers/docker_desktop_installer_mac_x86_64.dmg
            installers/docker_desktop_installer_linux_debian_x86_64.deb
            installers/docker_desktop_installer_linux_fedora_x86_64.rpm
            installers/docker_desktop_installer_linux_ubuntu_x86_64.deb
            installers/docker_desktop_installer_linux_centos_x86_64.rpm
        env: # è®¾ç½®æ­¤æ­¥éª¤çš„ç¯å¢ƒå˜é‡
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä¼ å…¥GITHUB_TOKENï¼Œç”¨äºæˆæƒactionåˆ›å»ºRelease

      - name: Output Release Notes # æ­¥éª¤9ï¼šå†æ¬¡è¾“å‡ºRelease Notes (å¯é€‰ï¼Œç”¨äºç¡®è®¤)
        run: | # æ‰§è¡Œå¤šè¡Œshellå‘½ä»¤
          set -euf -o pipefail # è®¾ç½®bashè„šæœ¬çš„ä¸¥æ ¼æ¨¡å¼ (æ·»åŠ å¦‚æ­¤å¤„ä¹Ÿéœ€è¦å¤„ç†é”™è¯¯)
          echo "Final Release Notes Content (from file):"
          if [ -f "release_notes.md" ]; then # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
             cat "release_notes.md" # åœ¨Runnerçš„æ§åˆ¶å°æ‰“å°æœ€ç»ˆçš„Release Noteså†…å®¹
          else
             echo "Warning: release_notes.md not found." # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æ‰“å°è­¦å‘Š
          fi
        continue-on-error: true # å³ä½¿æ­¤æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œå·¥ä½œæµï¼ˆè™½ç„¶æ˜¯æœ€åçš„å¯æ‰§è¡Œç”¨æˆ·æ­¥éª¤ï¼‰
